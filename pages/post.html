<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Homeroom Heroes - Discussion Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico" />
    <style>
        /* Ensure the font is applied globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Tailwind's bg-gray-800 */
            color: #f9fafb; /* Tailwind's text-gray-50 */
        }
        /* Custom styles for hamburger menu items */
        .menu-items .listButton {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            color: white;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-radius: 0.375rem; /* rounded-md */
        }
        .menu-items .listButton:hover {
            background-color: rgba(255, 255, 255, 0.1); /* Light hover effect */
        }
        /* Positioning for the dropdown menu */
        .menu-items {
            flex-direction: column; /* Stacks buttons vertically */
            position: absolute;
            top: 100%; /* Position below the header or its relative parent */
            right: 0;
            background-color: #1a472a; /* Darker green for dropdown */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 20;
            min-width: 150px;
            padding: 0.5rem;
        }

        /* Post Content: Ensure line breaks from the database are respected */
        #post-content {
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        /* Style for the floating success/error message */
        #floating-message {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-50">
    <header class="bg-gradient-to-r from-green-700 to-green-900 text-white shadow-lg py-4 md:py-6 relative">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center">
                <a href="/pages/homepage.html" class="flex items-center">
                    <!-- Note: Image path remains as a placeholder -->
                    <img src="/static/images/logo_transparent.png" alt="Homeroom Heroes Logo" class="h-16 md:h-20 mr-3">
                </a>
                <nav class="hidden md:flex ml-4">
                    <ul class="flex space-x-4 md:space-x-8 text-lg">
                        <li><a href="/pages/homepage.html" class="hover:text-green-200 transition duration-300 ease-in-out rounded-md p-2">Homepage</a></li>
                        <li><a href="/pages/index.html" class="hover:text-green-200 transition duration-300 ease-in-out rounded-md p-2">Donate</a></li>
                        <li><a href="/pages/register.html" class="hover:text-green-200 transition duration-300 ease-in-out rounded-md p-2">Sign Up</a></li>
                        <li><a href="/pages/about.html" class="hover:text-green-200 transition duration-300 ease-in-out rounded-md p-2">About</a></li>
                        <li><a href="/pages/contact.html" class="hover:text-green-200 transition duration-300 ease-in-out rounded-md p-2">Contact</a></li>
                        <li><a href="/pages/partners.html" class="hover:text-green-200 transition duration-300 ease-in-out rounded-md p-2">Radio Partners</a></li>
                    </ul>
                </nav>
            </div>

            <div class="relative">
                <button id="hamburgerButton" class="text-white text-3xl focus:outline-none" onclick="toggleMenu()">â˜°</button>

                <div class="menu-items absolute right-0 top-full mt-2 w-48 bg-green-800 rounded-md shadow-lg py-1 z-20 hidden" id="menuItems">
                    <!-- Authentication buttons will be displayed here -->
                    <button id="loginButton" class="listButton hidden" onclick="redirectTo('/pages/login.html')">Login</button>
                    <button id="logoutButton" class="listButton hidden" onclick="logout()">Logout</button>
                    <button id="mypageButton" class="listButton hidden" onclick="mypage()">My Page</button>
                    <button id="validationButton" class="listButton hidden" onclick="redirectTo('/pages/validation.html')">Validation</button>
                    <button id="createButton" class="listButton hidden" onclick="redirectTo('/pages/create.html')">Create Post</button>
                    <button id="adminButton" class="listButton hidden" onclick="redirectTo('/pages/admin.html')">Admin</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <section class="max-w-4xl mx-auto">
            <h2 class="text-4xl font-extrabold text-white mb-8 border-b border-green-700 pb-4">Discussion Detail</h2>
            
            <div class="mb-6">
                <button 
                    id="back-to-forum-button"
                    onclick="redirectTo('/pages/forum.html')" 
                    class="flex items-center text-green-300 hover:text-green-100 transition duration-200 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg shadow-md font-semibold"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Forum
                </button>
            </div>
            <div id="post-detail-card" class="bg-white p-8 rounded-xl shadow-2xl text-gray-800 min-h-[300px]">
                <div id="status-message" class="text-center p-10 text-xl font-medium text-blue-600">
                    Loading post details...
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-8 rounded-t-lg shadow-inner text-center">
        <div class="container mx-auto px-4 text-sm">
            <p>&copy; 2024 Homeroom Heroes. All rights reserved.</p>
        </div>
    </footer>
    
    <!-- Floating message box for feedback (Error/Success) -->
    <div id="floating-message" class="fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300"></div>

    <script>
        // --- Utility Functions ---

        // Helper function for redirection
        function redirectTo(url) {
            window.location.href = url;
        }

        // Function to toggle the mobile menu visibility
        function toggleMenu() {
            var menuItems = document.getElementById('menuItems');
            menuItems.classList.toggle('hidden');
        }

        // Utility function to format dates
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        /**
         * Parses the query parameters from the URL.
         * @returns {Object} Key-value pairs of query parameters.
         */
        function getQueryParameters() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const parts = param.split('=');
                if (parts[0]) {
                    params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
                }
            });
            return params;
        }

        // ----------------------------------------------------------------------
        // --- NEW COMMENTING UTILITIES AND LOGIC ---
        // ----------------------------------------------------------------------

        /**
         * Shows a temporary, non-blocking message to the user.
         * @param {string} message 
         * @param {'info'|'success'|'error'} type 
         */
        function showFloatingMessage(message, type = 'info') {
            let messageBox = document.getElementById('floating-message');
            // Ensure the box is visible and reset styles
            messageBox.style.opacity = '1';
            messageBox.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');

            // Set content and color based on type
            messageBox.textContent = message;
            if (type === 'success') {
                messageBox.classList.add('bg-green-600');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-600');
            } else {
                messageBox.classList.add('bg-blue-600');
            }

            // Hide after 3 seconds
            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 3000);
        }

        /**
         * Generates the HTML string for a single comment.
         * @param {Object} comment - The comment data object.
         * @returns {string} HTML string for the comment.
         */
        function createCommentHtml(comment) {
            // Note: We are currently ignoring parent_comment_id for nested rendering,
            // but the structure is ready to be expanded later.
            return `
                <div id="comment-${comment.id}" class="bg-gray-50 p-4 rounded-lg shadow-inner border-l-4 border-green-500">
                    <p class="text-sm text-gray-700 whitespace-pre-wrap overflow-wrap break-word">${comment.content}</p>
                    <div class="text-xs text-gray-500 mt-2 flex justify-between">
                        <!-- Displaying User ID as username placeholder until joined data is available -->
                        <span>Comment by User ID: <span class="font-semibold">${comment.user_id}</span></span> 
                        <span>${formatDate(comment.created_at)}</span>
                    </div>
                </div>
            `;
        }

        /**
         * Fetches and renders all existing comments for a post.
         * @param {number} postId - The ID of the post.
         */
        async function fetchAndRenderComments(postId) {
            const commentsListContainer = document.getElementById('comments-list-container');
            // Show a temporary loading message inside the container while fetching
            commentsListContainer.innerHTML = '<p class="text-gray-400 text-center p-4">Loading comments...</p>'; 

            try {
                const response = await fetch(`/forum/posts/${postId}/comments`);

                if (response.ok) {
                    const comments = await response.json();
                    
                    // Clear the loading message
                    commentsListContainer.innerHTML = ''; 
                    
                    if (comments.length === 0) {
                        commentsListContainer.innerHTML = '<p class="text-gray-500 p-4">No comments yet. Be the first to start the discussion!</p>';
                        return;
                    }

                    // Render comments (API returns newest first, so we use append to maintain that order)
                    comments.forEach(comment => {
                        commentsListContainer.insertAdjacentHTML('beforeend', createCommentHtml(comment));
                    });

                } else {
                    const errorData = await response.json();
                    commentsListContainer.innerHTML = `<p class="text-red-500 p-4">Failed to load comments: ${errorData.detail || 'Server error.'}</p>`;
                }
            } catch (error) {
                console.error("Network error fetching comments:", error);
                commentsListContainer.innerHTML = '<p class="text-red-500 p-4">Network error. Could not load comments.</p>';
            }
        }

        /**
         * Dynamically prepends a newly created comment to the comments list.
         * @param {Object} comment - The comment data object returned from the API.
         */
        function renderNewComment(comment) {
            const commentsListContainer = document.getElementById('comments-list-container');
            
            // Check for and remove the "No comments yet" message
            const initialMessage = commentsListContainer.querySelector('.text-gray-500');
            if (initialMessage && initialMessage.textContent.includes('No comments yet')) {
                commentsListContainer.innerHTML = '';
            }

            // Prepend the new comment to the top of the list
            commentsListContainer.insertAdjacentHTML('afterbegin', createCommentHtml(comment));
        }


        /**
         * Handles the submission of the comment form.
         * @param {Event} event - The form submission event.
         * @param {number} postId - The ID of the post the comment belongs to.
         */
        async function handleCommentSubmission(event, postId) {
            event.preventDefault(); // Stop the default form submission and page reload

            const contentTextarea = document.getElementById('comment-content');
            const content = contentTextarea.value.trim();

            if (!content) {
                showFloatingMessage('Comment content cannot be empty.', 'error');
                return;
            }

            // Prepare the data to be sent as application/x-www-form-urlencoded
            const formData = new URLSearchParams();
            formData.append('content', content);
            
            try {
                // Call the new API endpoint
                const response = await fetch(`/forum/posts/${postId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });

                if (response.ok) {
                    const newComment = await response.json();
                    showFloatingMessage('Comment posted successfully!', 'success');
                    
                    // 1. Clear the form field
                    contentTextarea.value = ''; 
                    
                    // 2. Instantly update the UI with the new comment
                    renderNewComment(newComment); 

                    // 3. Update the comment count display
                    const commentCountSpan = document.getElementById('comment-count-display');
                    if (commentCountSpan) {
                        commentCountSpan.textContent = parseInt(commentCountSpan.textContent) + 1;
                    }

                } else {
                    const errorData = await response.json();
                    const detail = errorData.detail || "Failed to post comment.";
                    console.error("Comment API Error:", detail);
                    // Provide a hint if they aren't logged in
                    showFloatingMessage(`Error: ${detail} (Are you logged in to comment?)`, 'error');
                }

            } catch (error) {
                console.error("Network Error during comment submission:", error);
                showFloatingMessage('Network Error: Could not reach the server to post comment.', 'error');
            }
        }


        // ----------------------------------------------------------------------
        // --- MODIFIED RENDER AND FETCH FUNCTIONS ---
        // ----------------------------------------------------------------------
        
        /**
         * Updates only the vote count display on the UI after a successful vote API call.
         * @param {Object} post - The post data object returned from the API.
         */
        function updatePostDisplay(post) {
            const voteCountSpan = document.getElementById('upvote-count');
            if (voteCountSpan) {
                // Update the cached count displayed to the user
                voteCountSpan.textContent = post.upvote_count;
                showFloatingMessage('Vote successfully recorded!', 'success');
            }
        }


        /**
         * Renders the fetched post data into the detail card.
         * Includes the new comment form and comments container.
         * @param {Object} post - The post data object.
         */
        function renderPost(post) {
            // Check if status-message exists before trying to remove it
            const statusMessage = document.getElementById('status-message');
            if (statusMessage) {
                 statusMessage.remove(); 
            }

            document.getElementById('page-title').textContent = `Homeroom Heroes - ${post.title}`;

            const card = document.getElementById('post-detail-card');
            const formattedDate = formatDate(post.created_at);

            // Updated HTML to include Comment Form and Comment List container
            card.innerHTML = `
                <div class="border-b pb-4 mb-4">
                    <h1 class="text-4xl font-extrabold text-green-800 mb-2">${post.title}</h1>
                    
                    <!-- Vote Section and Metadata -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between text-base text-gray-500">
                        
                        <!-- Left side: Vote Buttons and Count -->
                        <div class="flex items-center space-x-3 mb-3 md:mb-0">
                            <!-- Upvote Button -->
                            <button id="upvote-btn" 
                                        onclick="handleVote(${post.id}, 1)" 
                                        title="Upvote"
                                        class="text-gray-500 hover:text-green-600 active:text-green-800 transition duration-150 ease-in-out p-2 rounded-full bg-gray-100 hover:bg-green-100 shadow-md">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                </svg>
                            </button>
                            
                            <!-- Vote Count Display -->
                            <span id="upvote-count" class="text-2xl font-bold text-gray-800">${post.upvote_count}</span>
                            
                            <!-- Downvote Button -->
                            <button id="downvote-btn" 
                                        onclick="handleVote(${post.id}, -1)" 
                                        title="Downvote"
                                        class="text-gray-500 hover:text-red-600 active:text-red-800 transition duration-150 ease-in-out p-2 rounded-full bg-gray-100 hover:bg-red-100 shadow-md">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Right side: Post Metadata -->
                        <p class="mt-2 md:mt-0">Posted by <span class="font-semibold text-gray-700">${post.user_id}</span> on ${formattedDate}</p>
                    </div>
                </div>
                <div class="pt-4 text-lg">
                    <p id="post-content">${post.content}</p>
                </div>
                
                <!-- NEW COMMENTING SECTION -->
                <div class="pt-8 mt-8 border-t border-gray-200">
                    <h3 class="text-2xl font-bold text-green-700 mb-4">Leave a Comment</h3>
                    
                    <!-- Comment Form linked to new JS handler -->
                    <form id="comment-form" onsubmit="handleCommentSubmission(event, ${post.id})">
                        <textarea id="comment-content" name="content" 
                                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-y min-h-[100px] text-gray-800" 
                                placeholder="Share your thoughts..." 
                                required></textarea>
                        
                        <button type="submit" 
                                class="mt-3 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out">
                            Post Comment
                        </button>
                    </form>
                    
                    <!-- Comments Display Area -->
                    <div id="comments-list" class="mt-8 space-y-4">
                        <h3 class="text-2xl font-bold text-green-700 mb-4">
                            <span id="comment-count-display">${post.comment_count || 0}</span> Comments
                        </h3>
                        <!-- Container where comments will be dynamically inserted -->
                        <div id="comments-list-container" class="space-y-4">
                            <p class="text-gray-500 p-4">Loading existing comments...</p>
                        </div>
                    </div>
                </div>
            `;

            // CRITICAL: After rendering the post structure, fetch and display the comments
            fetchAndRenderComments(post.id);
        }

        /**
         * Displays an error message in the post detail area.
         * @param {string} message 
         */
        function displayError(message) {
            const statusBox = document.getElementById('status-message');
            // Ensure statusBox exists (it might have been removed by renderPost if an error occurred later)
            if (statusBox) {
                statusBox.classList.remove('text-blue-600');
                statusBox.classList.add('text-red-600', 'font-bold');
                statusBox.textContent = `Error: ${message}`;
            } else {
                 document.getElementById('post-detail-card').innerHTML = `<div id="status-message" class="text-center p-10 text-xl font-bold text-red-600">Error: ${message}</div>`;
            }
        }

        /**
         * Fetches a single post using the ID from the URL.
         */
        async function fetchPostDetail() {
            const params = getQueryParameters();
            const postId = params.id;

            if (!postId) {
                displayError("Post ID is missing from the URL. Please ensure you are navigating from the forum list.");
                return;
            }

            try {
                // Assuming the API endpoint is /forum/get_post?post_id=<ID>
                const apiUrl = `/forum/get_post?post_id=${postId}`;
                const response = await fetch(apiUrl);

                if (response.ok) {
                    const post = await response.json();
                    renderPost(post);
                    // fetchAndRenderComments is now called inside renderPost()
                } else {
                    const errorData = await response.json();
                    const detail = errorData.detail || `HTTP Error: ${response.status} ${response.statusText}.`;
                    displayError(`Failed to load post ${postId}: ${detail}`);
                    console.error("API Error Response:", errorData);
                }

            } catch (error) {
                displayError('Network Error: Could not reach the server to fetch the post.');
                console.error("Fetch Error:", error);
            }
        }

        /**
         * Sends the vote request to the FastAPI backend.
         * @param {number} postId - The ID of the post being voted on.
         * @param {1 | -1} voteType - 1 for Upvote, -1 for Downvote.
         */
        async function handleVote(postId, voteType) {
            const payload = { vote_type: voteType };
            
            try {
                const response = await fetch(`/forum/posts/${postId}/vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const updatedPost = await response.json();
                    updatePostDisplay(updatedPost);
                } else {
                    const errorData = await response.json();
                    const detail = errorData.detail || "Failed to process vote.";
                    console.error("Vote API Error:", detail);
                    // Display non-blocking error message
                    showFloatingMessage(`Error: ${detail} (Are you logged in?)`, 'error');
                }

            } catch (error) {
                console.error("Network Error during vote:", error);
                showFloatingMessage('Network Error: Could not reach the server.', 'error');
            }
        }

        
        // --- Authentication/Navigation Functions (Copied from your reference) ---

        async function checkAuthentication() {
            const buttons = ['loginButton', 'logoutButton', 'mypageButton', 'validationButton', 'createButton', 'adminButton'];
            buttons.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.classList.add('hidden');
                    button.classList.remove('block');
                }
            });

            let userRole = null; 

            try {
                const response = await fetch('/profile/');
                if (response.ok) {
                    const data = await response.json();
                    userRole = data?.user_role;
                }
            } catch (error) {
                console.error('Network or parsing error fetching user profile:', error);
            }

            if (userRole === 'teacher') {
                ['mypageButton', 'validationButton', 'logoutButton'].forEach(id => {
                    document.getElementById(id)?.classList.remove('hidden');
                    document.getElementById(id)?.classList.add('block');
                });
            } else if (userRole === 'admin') {
                ['adminButton', 'validationButton', 'createButton', 'logoutButton'].forEach(id => {
                    document.getElementById(id)?.classList.remove('hidden');
                    document.getElementById(id)?.classList.add('block');
                });
            } else {
                document.getElementById('loginButton')?.classList.remove('hidden');
                document.getElementById('loginButton')?.classList.add('block');
            }
        }

        async function logout() {
            try {
                await fetch(`/logout/`, { method: 'POST' });
                window.location.href = '/'; 
            } catch (error) {
                console.error('Error during logout:', error);
            }
        }

        async function mypage() {
            try {
                const response = await fetch('/myinfo/', { method: 'GET' });
                if (response.ok) {
                    window.location.href = '/pages/teacher.html';
                } else {
                    console.error('Error:', response.status);
                    window.location.href = '/'; 
                }
            } catch (error) {
                console.error('Error fetching my page info:', error);
                window.location.href = '/'; 
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            checkPermission();
            checkAuthentication();
            fetchPostDetail(); // This now handles the loading of comments as well.
        });
        /**
         * Checks if the user is an 'admin' or 'teacher' before allowing access to the page.
         * Redirects to /pages/403.html if unauthorized or unauthenticated.
         */
        async function checkPermission() {
            const allowedRoles = ['admin', 'teacher']; // Roles that are allowed access

            try {
                const response = await fetch('/profile/');

                if (!response.ok) {
                    // Case 1: Not authenticated (e.g., 401 Unauthorized or 403 Forbidden from server)
                    console.error('Permission Check Failed: Not authenticated or session expired.', response.status);
                    window.location.href = '/pages/403.html';
                    return; // Stop execution
                }

                const data = await response.json();
                const userRole = data?.user_role;
                
                // Case 2: Authenticated but unauthorized role
                if (!userRole || !allowedRoles.includes(userRole)) {
                    console.error('Permission Check Failed: User role is not authorized. Role:', userRole);
                    window.location.href = '/pages/403.html';
                    return; // Stop execution
                }
                
                // Success: User is logged in and has an allowed role ('admin' or 'teacher').
                // Execution continues normally.

            } catch (error) {
                // Case 3: Network error or JSON parsing failure
                console.error('Critical Error during permission check:', error);
                window.location.href = '/pages/403.html';
            }
        }
        
    </script>
</body>
</html>