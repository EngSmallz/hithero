<!DOCTYPE html>
<html>

<head>
    <title>Teacher Profile - Hometown Heroes</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
</head>

<body>
    <header>
        <h1>Teacher Profile</h1>
    </header>

    <nav>
        <ul>
            <li><a href="/pages/homepage.html">Home</a></li>
            <li><a href="/pages/about.html">About</a></li>
            <li><a href="/pages/contact.html">Contact</a></li>
        </ul>
    </nav>
    
    <button id="logoutButton" style="display: none" onclick="logout()">Logout</button>
    <button id="mypageButton" style="display: none" onclick="mypage()">My Page</button>

    <main id="main-container" style="display: none;">
        <section class="profile" id="profile-section">
            <div class="teacher-info" id="teacher-info">
                <img id="teacher-image">
                <h2 id="teacher-name"></h2>
                <p id="school-name"></p>
                <p id="location"></p>
                <!--<button id="updateImgBtn" style="display: none" onclick="updateImage()">Update Image</button>-->
            </div>

            <div class="wishlist" id="wishlist-section">
                <h2>Amazon Wishlist</h2>
                <p>Here is my Amazon wishlist where you can help support my classroom:</p>
                <p><button id="wishlistButton" onclick="wishlist()"> View Wishlist</button></p>
            </div>
        </section>

        <section class="about-me" id="about-me-section">
            <h2>About Me</h2>
            <p id="about-me"></p>
        </section>


        <button id="updateButton" onclick="redirectTo('/pages/edit_teacher.html')">Edit Info</button><p></p>
        <button id="updateButton" onclick="redirectTo('/pages/update_password.html')">Update Password</button><p></p>

    </main>

    <script>

        function redirectTo(url) {
            window.location.href = url;
        }

        function checkAuthentication() {
            fetch('/profile/')
                .then(response => response.json())
                .then(profileData => {
                    if (profileData) {
                        document.getElementById('logoutButton').style.display = 'block';
                        document.getElementById('mypageButton').style.display = 'block';

                        if (profileData.user_role === 'admin') {
                            document.getElementById('editButton').style.display = 'block';
                            document.getElementById('passButton').style.display = 'block';
                            document.getElementById('updateImgBtn').style.display = 'block';
                        }

                        if (profileData.user_role === 'teacher') { 
                            fetch('/check_access_teacher/')
                                .then(response => {
                                    if (response.ok) {
                                        document.getElementById('editButton').style.display = 'block';
                                        document.getElementById('passButton').style.display = 'block';
                                        document.getElementById('updateImgBtn').style.display = 'block';
                                    }
                                })
                                .catch(error => console.error('Error checking teacher role:', error));
                        }
                    } else {
                        document.getElementById('logoutButton').style.display = 'none';
                    }
                })
                .catch(error => console.error('Error checking authentication:', error));
        }
        window.onload = checkAuthentication;

        fetch('/get_teacher_info/')
            .then(response => response.json())
            .then(data => {
                if (data) {
                    document.getElementById('location').innerText = `Location: ${data.county}, ${data.state}`;
                    document.getElementById('teacher-name').innerText = data.name;
                    document.getElementById('school-name').innerText = `School: ${data.school}`;
                    document.getElementById('about-me').innerText = data.about_me;
                    const teacherImage = document.getElementById('teacher-image');
                    if (data.image_data){
                        teacherImage.src=data.image_data
                    }else{
                        teacherImage.src="/static/images/apple.jpg"
                    }
                    document.getElementById('main-container').style.display = 'block';
                }
            })
            .catch(error => console.error('Error fetching teacher info:', error));

        async function logout() {
            try {
                const response = await fetch(`/logout/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                window.location.href = '/';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function wishlist() {
            try {
                const response = await fetch('/get_teacher_info/');
                const data = await response.json();
                if (data && data.wishlist_url) {
                    window.location.href = data.wishlist_url;
                } else {
                    console.error('Wishlist URL not found.');
                }
            } catch (error) {
                console.error('Error fetching teacher info:', error);
            }
        }

        async function mypage() {
            try {
                const response = await fetch('/myinfo/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                if (response.ok) {
                    window.location.href = '/pages/teacher.html';
                } else {
                    console.error('Error:', response.status);
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/';
            }
        }

        async function updateImage() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/jpeg';
                fileInput.click();
                fileInput.addEventListener('change', async (event) => {
                    const selectedFile = event.target.files[0];
                    if (selectedFile) {
                        const formData = new FormData();
                        formData.append('image', selectedFile);

                        try {
                            const response = await fetch('/update_teacher_image/', {
                                method: 'POST',
                                body: formData,
                            });
                            if (response.ok) {
                                location.reload();
                            } else {
                                const errorMessage = `Error updating teacher image: ${response.status}`;
                                console.error(errorMessage);
                            }
                        } catch (error) {
                            const errorMessage = `Error updating teacher image: ${error.message}`;
                            console.error(errorMessage);
                        }
                    }
                });
            } catch (error) {
                const errorMessage = `Error opening file explorer: ${error.message}`;
                console.error(errorMessage);
            }
        }

    </script>

    <footer>
        <p>&copy; 2023 Hometown Heroes</p>
    </footer>
</body>

</html>
