<!DOCTYPE html>
<html>
<head>
    <title>Teacher Profile - Homeroom Heroes</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico" />
</head>
<script>
    function checkAuthentication() {
        fetch('/profile/')
            .then(response => response.json())
            .then(data => {
                if (data.user_role === 'teacher') {
                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('mypageButton').style.display = 'block';
                    document.getElementById('validationButton').style.display = 'block';
                    fetch('/check_access_teacher/')
                        .then(response => {
                            if (response.ok) {
                                document.getElementById('editButton').style.display = 'block';
                                document.getElementById('updateButton').style.display = 'block';
                                document.getElementById('updateImgBtn').style.display = 'block';
                            }
                        })
                } else if (data.user_role === 'admin') {
                    document.getElementById('editButton').style.display = 'block';
                    document.getElementById('updateButton').style.display = 'block';
                    document.getElementById('updateImgBtn').style.display = 'block';
                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('validationButton').style.display = 'block';
                    document.getElementById('createButton').style.display = 'block';
                } else {
                    throw new Error('Unknown role');
                }
            })
            .catch(error => {
                console.error('Error checking authentication:', error);
                document.getElementById('loginButton').style.display = 'block';
            });
    }

    window.onload = checkAuthentication;
</script>
<body>
    <nav>
        <ul>
            <li>
                <a href="/pages/homepage.html">
                    <img src="\static\images\logo_transparent.png" alt="Logo" style="height: 75px; vertical-align: middle;">
                </a>
            </li>
            <li><a href="/pages/about.html">About</a></li>
            <li><a href="/pages/contact.html">Contact</a></li>
            <li><a href="/pages/register.html">Sign Up</a></li>
        </ul>
    </nav>
    
    <button id="logoutButton" style="display: none" onclick="logout()">Logout</button>
    <button id="loginButton" style="display: none" onclick="redirectTo('/pages/login.html')">Login</button>
    <button id="mypageButton" style="display: none" onclick="mypage()">My Page</button>
    <button id="validationButton" style="display: none" onclick="redirectTo('/pages/validation.html')">Validation</button>
    <button id="createButton" style="display: none" onclick="redirectTo('/pages/create.html')">Create Profile</button>

     <main id="main-container" style="display: none;">
        <section class="profile" id="profile-section">
            <div class="teacher-info" id="teacher-info">
                <img id="teacher-image" src="teacher-image.jpg" alt="Teacher Image">
                <div>
                    <h2 id="teacher-name">Teacher Name</h2>
                    <p id="school-name">School Name</p>
                    <p id="location">Location</p>
                    <button id="updateImgBtn" style="display: none" onclick="updateImage()">Update Image</button>
                </div>
            </div>

            <div class="wishlist" id="wishlist-section">
                <h2>Amazon Wishlist</h2>
                <p>Here is my Amazon wishlist where you can help support my classroom:</p>
                <p><button id="wishlistButton" onclick="wishlist()"> View Wishlist</button></p>
            </div>
        </section>

        <section class="about-me" id="about-me-section">
            <h2>About Me</h2>
            <p id="about-me"></p>
        </section>


        <button id="editButton" style="display: none" onclick="redirectTo('/pages/edit_teacher.html')">Edit Info</button><p></p>
        <button id="updateButton" style="display: none" onclick="redirectTo('/pages/update_password.html')">Update Password</button><p></p>
        <button id="shareButton" onclick="getTeacherURL()">Share Page</button><p></p>

    </main>

    <script>
        function redirectTo(url) {
            window.location.href = url;
        }

        fetch('/get_teacher_info/')
            .then(response => response.json())
            .then(data => {
                if (data) {
                    document.getElementById('location').innerText = `Location: ${data.county}, ${data.state}`;
                    document.getElementById('teacher-name').innerText = data.name;
                    document.getElementById('school-name').innerText = `School: ${data.school}`;
                    document.getElementById('about-me').innerText = data.about_me;
                    const teacherImage = document.getElementById('teacher-image');
                    if (data.image_data){
                        teacherImage.src = `data:image/jpeg;base64,${data.image_data}`;
                    }else{
                        teacherImage.src="/static/images/apple.jpg"
                    }
                    document.getElementById('main-container').style.display = 'block';
                }
            })
            .catch(error => console.error('Error fetching teacher info:', error));
        
        function redirectTo(url) {
                window.location.href = url;
            }

        async function logout() {
            try {
                const response = await fetch(`/logout/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                window.location.href = '/';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function wishlist() {
            try {
                const response = await fetch('/get_teacher_info/');
                const data = await response.json();
                if (data && data.wishlist_url) {
                    window.location.href = data.wishlist_url;
                } else {
                    console.error('Wishlist URL not found.');
                }
            } catch (error) {
                console.error('Error fetching teacher info:', error);
            }
        }

        async function mypage() {
            try {
                const response = await fetch('/myinfo/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                if (response.ok) {
                    window.location.href = '/pages/teacher.html';
                } else {
                    console.error('Error:', response.status);
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/';
            }
        }

        const MAX_FILE_SIZE_MB = 1;  // Maximum allowed file size in MB

        async function updateImage() {
            try {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/jpeg';
                fileInput.click();
                fileInput.addEventListener('change', async (event) => {
                    const selectedFile = event.target.files[0];
                    if (selectedFile) {
                        if (selectedFile.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                            alert(`File size exceeds the allowed limit of ${MAX_FILE_SIZE_MB}MB. Please upload a smaller image.`);
                            return;
                        }
                        const formData = new FormData();
                        formData.append('image', selectedFile);
                        try {
                            const response = await fetch('/update_teacher_image/', {
                                method: 'POST',
                                body: formData,
                            });
                            if (response.ok) {
                                location.reload();
                            } else if (response.status === 400) {
                                const responseData = await response.json();
                                throw new Error(responseData.detail);
                            } else {
                                throw new Error(`Error updating teacher image: ${response.status}`);
                            }
                        } catch (error) {
                            console.error(`Error updating teacher image: ${error.message}`);
                            alert(`Error updating teacher image: ${error.message}`);
                        }
                    }
                });
            } catch (error) {
                console.error(`Error opening file explorer: ${error.message}`);
                alert(`Error opening file explorer: ${error.message}`);
            }
        }

        async function getTeacherURL() {
            try {
                const response = await fetch('/teacher_url/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();  // Parse as JSON
                    await navigator.clipboard.writeText(data.url);
                    alert("Teacher URL has been copied to clipboard!");
                } else {
                    console.error('Error:', response.status);
                    alert(`Error: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            }
        }

    </script>

    <footer>
        <p>&copy; 2023 Homeroom Heroes</p>
    </footer>
</body>

</html>
