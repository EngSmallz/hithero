<!DOCTYPE html>
<html>
<head>
    <title>Homeroom Heroes - Validation Page</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" type="image/x-icon" href="/static/images/favicon.ico" />
</head>
<script>
    function checkPermission() {
        fetch('/profile/')
            .then(response => response.json())
            .catch(error => {
                console.error('Error checking permission:', error);
                window.location.href = '/pages/403.html';
            });
            get_list()
    }
    window.onload = checkPermission;

    function checkAuthentication() {
        fetch('/profile/')
            .then(response => response.json())
            .then(data => {
                if (data.user_role === 'teacher') {
                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('mypageButton').style.display = 'block';
                    document.getElementById('validationButton').style.display = 'block';
                } else if (data.user_role === 'admin') {
                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('validationButton').style.display = 'block';
                    document.getElementById('createButton').style.display = 'block';
                } else {
                    document.getElementById('loginButton').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching user profile:', error);
                document.getElementById('loginButton').style.display = 'block';
                // Handle error if necessary
            });
    }
    
    function toggleMenu() {
        var menuItems = document.getElementById('menuItems');
        if (menuItems.style.display === 'block') {
            menuItems.style.display = 'none';
        } else {
            menuItems.style.display = 'block';
            checkAuthentication();
        }
    }
</script>
<body>
    <nav>
        <ul>
            <li>
                <a href="/pages/homepage.html">
                    <img src="\static\images\logo_transparent.png" alt="Logo" style="height: 75px; vertical-align: middle;">
                </a>
            </li>
            <li><a href="/pages/homepage.html">Home</a></li>
            <li><a href="/pages/register.html">Sign Up</a></li>
            <li><a href="/pages/about.html">About</a></li>
            <li><a href="/pages/contact.html">Contact</a></li>
            <li><a href="/pages/partners.html">Radio Partners</a></li>
        </ul>
    </nav>
    
    <div class="hamburger-menu">
        <button id="hamburgerButton" onclick="toggleMenu()">â˜°</button>
        <div class="menu-items" id="menuItems">
            <button id="loginButton" class="listButton" onclick="redirectTo('/pages/login.html')">Login</button>
            <button id="logoutButton" class="listButton" onclick="logout()">Logout</button>
            <button id="mypageButton" class="listButton" onclick="mypage()">My Page</button>
            <button id="validationButton" class="listButton" onclick="redirectTo('/pages/validation.html')">Validation</button>
            <button id="createButton" class="listButton" onclick="redirectTo('/pages/create.html')">Create</button>
        </div>
    </div>
     
    <main>
        <h2> How Validation Works</h2>
        <p>
            The validation process allows Homeroom Heroes to ensure only teachers are signing up.
            This way, our donors know they are donating to teachers.
            Below is a list of teacher in your school district looking to create their profiles.
            If you know them and can validate them with the information present, then please press the green "Validate" button.
            If you believe someone other than the teacher signed up with fake information, then please press the red "Report" button and we will investigate.
        </p>
        <h2>Validation List</h2>
        <ul id="validationList"></ul>

    </main>
    <script>
        function redirectTo(url) {
                window.location.href = url;
            }
            
        function get_list(){
            fetch(`/validation_list/`)
                .then(response => response.json())
                .then(data => {
                    const validationList = document.getElementById("validationList");
                    validationList.innerHTML = "";
                    data.new_users.forEach(user => {
                        const listItem = document.createElement("li");
                        const endItem = document.createElement("p");
                        const userInfoSpan = document.createElement("span");
                        userInfoSpan.textContent = `${user.name} - ${user.email} - ${user.state} - ${user.district} - ${user.school} - ${user.phone_number} `;
                        const validateButton = document.createElement("button");
                        validateButton.textContent = "Validate";
                        validateButton.id = "submitButton";
                        validateButton.addEventListener("click", () => validate(user.email));
                        listItem.appendChild(userInfoSpan);
                        listItem.appendChild(validateButton);
                        const space = document.createTextNode(' ');
                        listItem.appendChild(space);
                        if (data.role === 'admin'){  
                            if (user.emailed === 0) {  // Check if the user has not been emailed
                                const emailButton = document.createElement("button");
                                emailButton.textContent = "Emailed User";
                                emailButton.id = "submitButton";
                                emailButton.addEventListener("click", () => emailUser(user.email));
                                listItem.appendChild(emailButton);
                                const space2 = document.createTextNode(' ');
                                listItem.appendChild(space2);
                            }
                            const deleteButton = document.createElement("button");
                            deleteButton.textContent = "Delete";
                            deleteButton.id = "registerButton";
                            deleteButton.addEventListener("click", () => deleteUser(user.email));
                            listItem.appendChild(deleteButton);
                            if (user.report === 1){
                            const userReport = document.createElement("span");
                            userReport.textContent = ` REPORTED `;
                            listItem.appendChild(userReport);
                            } 
                        }else{
                            const reportButton = document.createElement("button");
                            reportButton.textContent = "Report";
                            reportButton.id = "registerButton";
                            reportButton.addEventListener("click", () => reportUser(user.email));
                            listItem.appendChild(reportButton);
                        }
                        validationList.appendChild(listItem);
                        validationList.appendChild(endItem)
                    });
                })
                .catch(error => console.error('Error:', error));
        }
        
        async function validate(email) {
            try {
                const validateResponse = await fetch(`/validate_user/${email}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (validateResponse.ok) {
                    alert(`Validation successful for user: ${email}`);
                    window.location.reload();
                } else {
                    alert(`Validation failed for user: ${email}`);
                }
            } catch (error) {
                alert('Error validating user:', error);
            }
        }

        async function deleteUser(email) {
            try {
                const deleteResponse = await fetch(`/delete_user/${email}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (deleteResponse.ok) {
                    alert(`Delete successful for user: ${email}`);
                    window.location.reload();
                } else {
                    alert(`Delete failed for user: ${email}`);
                }
            } catch (error) {
                alert('Error deleting user:', error);
            }
        }

        async function reportUser(email) {
            try {
                const reportResponse = await fetch(`/report_user/${email}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (reportResponse.ok) {
                    alert(`Report successful for user: ${email}`);
                } else {
                    alert(`Report failed for user: ${email}`);
                }
            } catch (error) {
                alert('Error reporting user:', error);
            }
        }

        async function emailUser(email) {
            try {
                const emailResponse = await fetch(`/emailed_user/${email}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (emailResponse.ok) {
                    alert(`email successful for user: ${email}`);
                    window.location.reload();
                } else {
                    alert(`email failed for user: ${email}`);
                }
            } catch (error) {
                alert('Error emailing user:', error);
            }
        }
        
        async function logout() {
                try {
                    const response = await fetch(`/logout/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                    window.location.href = '/';
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            async function mypage() {
            try {
                const response = await fetch('/myinfo/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                if (response.ok) {
                    window.location.href = '/pages/teacher.html';
                } else {
                    console.error('Error:', response.status);
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error:', error);
                window.location.href = '/';
            }
        }
    </script>
    <footer>
        <p>2024 Homeroom Heroes</p>
    </footer>
</body>
</html>
